<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-IZIN 110 | STARLIGHT VERSION</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #030712; color: white; min-height: 100vh; margin: 0; overflow-x: hidden; }
    
    /* ANIMASI BINTANG */
    #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

    /* GLOW LOGIN BOX */
    .login-glow { position: relative; z-index: 10; }
    .login-glow::before {
      content: ""; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px;
      background: linear-gradient(45deg, #6366f1, #a855f7, #6366f1);
      z-index: -1; border-radius: 3.1rem; filter: blur(15px); opacity: 0.4;
      animation: shiftGlow 4s linear infinite;
    }
    @keyframes shiftGlow { 0%, 100% { opacity: 0.4; filter: blur(15px); } 50% { opacity: 0.7; filter: blur(20px); } }

    .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }

    /* KOTAK REKAP SOLID (TIDAK TRANSPARAN) */
    .solid-card { 
      background: #0f172a; /* Warna Biru Gelap Pekat */
      border: 1px solid #1e293b; 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* TOMBOL 3D PUSHABLE */
    .btn-3d-pushable { position: relative; background: #3730a3; border-radius: 1rem; border: none; padding: 0; cursor: pointer; width: 100%; }
    .btn-3d-front {
      display: block; position: relative; padding: 1rem; border-radius: 1rem; font-size: 1.1rem;
      color: white; background: #6366f1; transform: translateY(-6px); transition: transform 34ms;
    }
    .btn-3d-pushable:active .btn-3d-front { transform: translateY(-2px); }

    .hidden-section { display: none !important; }
    .input-upper { text-transform: uppercase; }

    /* TABEL ANTI-TURUN */
    .table-container { overflow-x: auto; width: 100%; border-radius: 1rem; }
    table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.4); border: 1px solid #334155; }
    th, td { padding: 12px 15px; border: 1px solid #334155; font-size: 12px; text-align: center; }
    th { background: rgba(99, 102, 241, 0.3); color: white; white-space: nowrap; }
    .col-nama { text-align: left !important; white-space: nowrap !important; font-weight: 700; min-width: 220px; }
    
    input, select, textarea { 
        background: #1e293b !important; border: 1px solid #334155 !important; 
        color: white !important; border-radius: 0.8rem !important; text-align: center; width: 100%;
    }
  </style>
</head>
<body class="p-4 flex flex-col items-center justify-center">

  <canvas id="starCanvas"></canvas>

  <div id="loginPage" class="w-full max-w-md my-auto pt-10">
    <div class="login-glow">
      <div class="glass p-10 rounded-[3rem] text-center shadow-2xl">
        <div class="flex justify-center mb-4">
          <img src="https://i.ibb.co.com/MDTybQJn/LOGO-CX-OK.png" alt="Logo Sekolah" class="h-24 w-auto drop-shadow-lg">
        </div>
        <h1 class="text-3xl font-black uppercase italic tracking-tighter mb-1">E - I Z I N</h1>
        <h2 class="text-sm font-bold tracking-widest text-indigo-400 mb-6">SMPN 110 JAKARTA</h2>
        <input type="text" id="loginInput" placeholder="NIS / USERNAME" class="p-4 mb-6 font-bold input-upper outline-none" autocomplete="off">
        <button onclick="handleLogin()" class="btn-3d-pushable">
          <span class="btn-3d-front font-black uppercase tracking-wider">Masuk</span>
        </button>
      </div>
    </div>
  </div>

  <div id="siswaDashboard" class="hidden-section w-full max-w-lg space-y-6 pt-6">
    <div class="glass p-6 rounded-[2rem] flex flex-col items-center text-center border-t-8 border-indigo-500 shadow-xl">
      <h2 id="siswaName" class="text-xl font-bold uppercase">...</h2>
      <p id="siswaKelasLabel" class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest mt-1"></p>
      <button onclick="location.reload()" class="mt-4 p-3 bg-rose-500/20 text-rose-500 rounded-2xl border border-rose-500/20 shadow-lg"><i data-lucide="power"></i></button>
    </div>
    
    <div class="glass p-8 rounded-[2.5rem] space-y-5 shadow-2xl">
      <input type="text" id="namaOrtu" placeholder="NAMA ORANG TUA" class="p-4 font-bold uppercase">
      <select id="alasanIzin" class="p-4 font-bold">
        <option value="Sakit">Sakit</option>
        <option value="Izin Keperluan">Izin Keperluan</option>
      </select>
      <textarea id="ketIzin" class="p-4 h-24 text-center" placeholder="Detail alasan..."></textarea>
      <button onclick="konfirmasiKirim()" class="btn-3d-pushable">
          <span class="btn-3d-front font-black uppercase tracking-wider">Kirim Laporan</span>
      </button>
    </div>
  </div>

  <div id="waliDashboard" class="hidden-section w-full max-w-6xl space-y-6">
    <div class="glass p-8 rounded-[3rem] flex flex-col items-center justify-center text-center border-t-[10px] border-indigo-600 shadow-xl">
      <h2 class="text-4xl font-black italic uppercase tracking-tighter">
        <span id="titleRole">KELAS</span> <span id="labelKelas" class="text-indigo-500"></span>
      </h2>
      <p id="waliName" class="text-[11px] text-indigo-300 font-bold uppercase tracking-widest mt-2"></p>
      <div id="saveStatus" class="text-emerald-500 font-bold text-[10px] uppercase mt-3 px-3 py-1 bg-emerald-500/10 rounded-full">
        ● Status: Siaga
      </div>
      <div class="flex gap-4 mt-8">
        <button onclick="toggleViewWali('hariIni')" class="p-5 bg-indigo-500/20 text-indigo-400 rounded-2xl border border-indigo-500/20 shadow-lg hover:bg-indigo-500/30 transition-all">
          <i data-lucide="calendar-check"></i>
        </button>
        <button onclick="toggleViewWali('rekap')" class="p-5 bg-amber-500/20 text-amber-400 rounded-2xl border border-amber-400/20 shadow-lg hover:bg-amber-500/30 transition-all">
          <i data-lucide="database"></i>
        </button>
        <button onclick="location.reload()" class="p-5 bg-rose-500/20 text-rose-500 rounded-2xl border border-rose-500/20 shadow-lg hover:bg-rose-500/30 transition-all">
          <i data-lucide="power"></i>
        </button>
      </div>
    </div>

    <div id="sectionHariIni" class="glass p-6 rounded-[2.5rem] border-t-4 border-indigo-400">
      <div class="text-indigo-400 font-bold uppercase text-xs italic mb-4">Laporan Masuk Hari Ini</div>
      <div class="table-container">
        <table>
            <thead><tr><th>No</th><th>NIS</th><th class="col-nama">Nama Siswa</th><th>Kelas</th><th>Status</th><th>Keterangan</th></tr></thead>
            <tbody id="hariIniBodyWali"></tbody>
        </table>
      </div>
    </div>

    <div id="sectionRekap" class="hidden-section solid-card p-6 rounded-[2.5rem] border-t-4 border-amber-500">
      <div class="flex justify-between items-center mb-6">
        <div class="text-amber-400 font-bold uppercase text-xs italic">Data Rekap Kumulatif</div>
        <button onclick="cetakRekapPDF()" class="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg text-[10px] font-bold border border-emerald-500/30 flex gap-2"><i data-lucide="printer" class="w-4 h-4"></i> PDF</button>
      </div>
      <div class="table-container">
        <table id="tableRekapUtama">
            <thead><tr><th>No</th><th>NIS</th><th class="col-nama">Nama Siswa</th><th>Kelas</th><th>S</th><th>I</th><th class="text-rose-400">A</th><th>Total</th></tr></thead>
            <tbody id="rekapBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // --- ANIMASI BINTANG ---
    const canvas = document.getElementById('starCanvas');
    const ctx = canvas.getContext('2d');
    let width, height, stars;
    function initStars() {
      width = window.innerWidth; height = window.innerHeight;
      canvas.width = width; canvas.height = height; stars = [];
      for (let i = 0; i < 150; i++) stars.push({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 1.5 + 0.5, speed: Math.random() * 0.8 + 0.2, opacity: Math.random() });
    }
    function drawStars() {
      ctx.clearRect(0, 0, width, height);
      for (let s of stars) {
        ctx.fillStyle = rgba(255, 255, 255, ${s.opacity}); ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
        s.y += s.speed; if (s.y > height) { s.y = -5; s.x = Math.random() * width; }
      }
      requestAnimationFrame(drawStars);
    }
    window.addEventListener('resize', initStars); initStars(); drawStars();

    // --- LOGIKA UTAMA ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxB7YdqjkW9l9HQ6qbI2ow7-JOroGVsXs1ExdW7uJmBXvjTKRNjOVh4nxvuIPSEzMRlxA/exec"; 
    let userAktif = null;
    let dataHariIniGlobal = [];
    let saveTimeout = null;

    lucide.createIcons();

    async function handleLogin() {
      const input = document.getElementById('loginInput').value.trim().toUpperCase();
      if (!input) return;
      try {
        const res = await fetch(${API_URL}?action=login&username=${encodeURIComponent(input)});
        const data = await res.json();
        if (data.status === "success") {
          userAktif = data.user;
          document.getElementById('loginPage').classList.add('hidden-section');
          if (userAktif.role.toLowerCase() === 'siswa') {
            document.getElementById('siswaDashboard').classList.remove('hidden-section');
            document.getElementById('siswaName').innerText = userAktif.nama;
            document.getElementById('siswaKelasLabel').innerText = "NIS: " + userAktif.nis + " | KELAS: " + userAktif.kelas;
          } else {
            document.getElementById('waliDashboard').classList.remove('hidden-section');
            document.getElementById('labelKelas').innerText = userAktif.kelas;
            document.getElementById('titleRole').innerText = userAktif.kelas === "110" ? "PIKET" : "KELAS";
            document.getElementById('waliName').innerText = "USER: " + userAktif.nama;
            loadDataWali();
          }
          lucide.createIcons();
        } else { Swal.fire('Gagal', 'User tidak ditemukan', 'error'); }
      } catch (e) { Swal.fire('Error', 'Server sibuk, coba lagi', 'error'); }
    }

    async function loadDataWali() {
      const [resH, resR] = await Promise.all([
        fetch(${API_URL}?action=getIzinHariIni&kelas=${encodeURIComponent(userAktif.kelas)}),
        fetch(${API_URL}?action=getAdminData&kelas=${encodeURIComponent(userAktif.kelas)})
      ]);
      dataHariIniGlobal = await resH.json();
      renderTabelHariIni(dataHariIniGlobal);
      renderTabelRekap(await resR.json());
    }

    function renderTabelHariIni(data) {
      document.getElementById('hariIniBodyWali').innerHTML = data.map((s, i) => `
        <tr><td>${i+1}</td><td>${s.nis}</td><td class="col-nama">${s.nama}</td><td class="text-amber-400 font-bold">${s.kelas_siswa}</td><td>${s.status}</td><td class="text-[10px] italic text-slate-400">${s.keterangan}</td></tr>
      `).join('');
    }

    function renderTabelRekap(data) {
      document.getElementById('rekapBody').innerHTML = data.map((s, i) => `
        <tr data-nis="${s.nis}"><td>${i+1}</td><td>${s.nis}</td><td class="col-nama">${s.nama}</td><td class="text-amber-400 font-bold">${s.kelas_siswa}</td>
        <td><input type="number" class="w-12 val-s" value="${s.rekap?.S || 0}" oninput="autoSave(this)"></td>
        <td><input type="number" class="w-12 val-i" value="${s.rekap?.I || 0}" oninput="autoSave(this)"></td>
        <td><input type="number" class="w-12 val-a text-rose-400" value="${s.rekap?.A || 0}" oninput="autoSave(this)"></td>
        <td class="row-total font-black text-indigo-400">${(parseInt(s.rekap?.S)||0)+(parseInt(s.rekap?.I)||0)+(parseInt(s.rekap?.A)||0)}</td></tr>
      `).join('');
    }

    function autoSave(input) {
      const tr = input.closest('tr');
      tr.querySelector('.row-total').innerText = (parseInt(tr.querySelector('.val-s').value)||0) + (parseInt(tr.querySelector('.val-i').value)||0) + (parseInt(tr.querySelector('.val-a').value)||0);
      document.getElementById('saveStatus').innerText = "● Menyimpan...";
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const rows = Array.from(document.querySelectorAll('#rekapBody tr')).map(r => ({
          nis: r.dataset.nis, s: r.querySelector('.val-s').value, i: r.querySelector('.val-i').value, a: r.querySelector('.val-a').value
        }));
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateBulkAbsen', data: rows }) });
        document.getElementById('saveStatus').innerText = "● Data Tersimpan";
      }, 1500);
    }

    function toggleViewWali(view) {
      document.getElementById('sectionHariIni').classList.toggle('hidden-section', view !== 'hariIni');
      document.getElementById('sectionRekap').classList.toggle('hidden-section', view !== 'rekap');
    }

    async function konfirmasiKirim() {
      const ortu = document.getElementById('namaOrtu').value.trim();
      const ket = document.getElementById('ketIzin').value.trim();
      if(!ortu || !ket) return Swal.fire('Lengkapi Data', '', 'warning');
      const p = new URLSearchParams({ action: 'submitIzin', nis: userAktif.nis, nama_siswa: userAktif.nama, kelas: userAktif.kelas, alasan: document.getElementById('alasanIzin').value, keterangan: ket, nama_ortu: ortu });
      await fetch(${API_URL}?${p.toString()});
      Swal.fire('Berhasil!', 'Laporan terkirim', 'success').then(() => location.reload());
    }

    function cetakRekapPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      doc.text(REKAPITULASI ABSENSI ${userAktif.kelas}, 105, 15, { align: 'center' });
      doc.autoTable({ html: '#tableRekapUtama', startY: 22, theme: 'grid' });
      doc.save(Rekap_Absensi.pdf);
    }
  </script>
</body>
</html>