<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>E-IZIN | SMPN 110 Jakarta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: radial-gradient(circle at top right, #0f172a, #020617); color: #e5e7eb; font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; }
        .tab-btn.active { background: linear-gradient(135deg, #22d3ee, #0ea5e9); color: #020617; box-shadow: 0 8px 20px -4px rgba(34, 211, 238, 0.4); }
        .filter-btn { padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; transition: 0.3s; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; }
        .filter-btn.active { background: #22d3ee; color: #020617; border-color: #22d3ee; }
        .input-modern { background: rgba(2, 6, 23, 0.5) !important; border: 1px solid #334155 !important; border-radius: 12px !important; padding: 10px !important; width: 100% !important; text-align: center !important; color: white !important; font-size: 0.9rem; }
        .input-kode { background: rgba(2, 6, 23, 0.6) !important; border: 1px solid rgba(34, 211, 238, 0.3) !important; border-radius: 12px !important; color: #22d3ee !important; text-align: center !important; letter-spacing: 0.5em; font-weight: bold; width: 180px !important; margin: 10px auto !important; height: 45px !important; }
        .chart-card { background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.6)); border: 1px solid rgba(255, 255, 255, 0.05); overflow: hidden; }
        .table-container { border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); }
        table { width: 100%; border-collapse: collapse; }
        thead th { padding: 12px; font-size: 0.65rem; color: #22d3ee; background: rgba(30, 41, 59, 0.5); }
        td { padding: 12px 6px; text-align: center; font-size: 0.8rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .swal2-popup-custom { background: rgba(15, 23, 42, 0.95) !important; backdrop-filter: blur(20px) !important; border-radius: 2rem !important; }
    </style>
</head>
<body class="p-4 pb-20">

    <header class="max-w-4xl mx-auto mb-8 mt-6 text-center">
        <div class="glass p-6">
            <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">SMPN 110 JAKARTA</h1>
            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-[0.4em] font-bold">E-Izin Digital System</p>
        </div>
    </header>

    <nav class="flex justify-center gap-3 mb-8">
        <button class="tab-btn active px-6 py-3 rounded-2xl text-sm font-semibold transition-all" onclick="showTab('izin', this)">üìù Form</button>
        <button class="tab-btn px-6 py-3 rounded-2xl text-sm font-semibold transition-all" onclick="verifyAccess('wali', this)">üë©‚Äçüè´ Wali</button>
        <button class="tab-btn px-6 py-3 rounded-2xl text-sm font-semibold transition-all" onclick="verifyAccess('piket', this)">üïò Piket</button>
    </nav>

    <main class="max-w-4xl mx-auto">
        <section id="izin" class="tab-content glass max-w-lg mx-auto p-8">
            <form id="izinForm" class="space-y-5">
                <select id="kelas_select" required onchange="filterNama()" class="input-modern"></select>
                <select id="nama_murid" required onchange="isiDataSiswa()" class="input-modern"><option value="">-- pilih nama --</option></select>
                <div class="grid grid-cols-2 gap-4">
                    <input id="nis" readonly class="input-modern opacity-50" placeholder="NIS">
                    <select id="alasan" class="input-modern">
                        <option>sakit</option>
                        <option>izin</option>
                    </select>
                </div>
                <input id="nama_wali" required placeholder="nama orang tua/wali" oninput="this.value=this.value.toUpperCase()" class="input-modern">
                <textarea id="keterangan" rows="2" placeholder="detail alasan..." oninput="this.value=this.value.toLowerCase()" class="input-modern"></textarea>
                <button type="submit" class="w-full bg-gradient-to-br from-cyan-400 to-blue-600 text-slate-900 font-extrabold py-4 rounded-2xl active:scale-95 transition-all">KIRIM DATA & PDF</button>
            </form>
        </section>

        <section id="wali" class="tab-content hidden glass p-6">
            <h2 id="judul_wali" class="font-bold text-cyan-400 text-sm uppercase tracking-widest text-center mb-8">Data Izin</h2>
            <div class="table-container overflow-x-auto">
                <table>
                    <thead><tr><th>No</th><th>Tanggal</th><th>Nama Siswa</th><th>Alasan</th><th>File</th></tr></thead>
                    <tbody id="wali_data"></tbody>
                </table>
            </div>
        </section>

        <section id="piket" class="tab-content hidden glass p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold text-cyan-400 text-sm uppercase tracking-widest">Monitoring Piket</h2>
                <div class="flex gap-2">
                    <button onclick="loadPiket()" class="p-2 bg-slate-800 rounded-xl border border-slate-700">üîÑ</button>
                    <button onclick="toggleGrafik()" class="p-2 bg-cyan-500/10 text-cyan-400 border border-cyan-500/50 rounded-xl">üìä</button>
                </div>
            </div>
            <div id="section-grafik" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="chart-card p-6 rounded-3xl h-[200px]"><canvas id="chartHarian"></canvas></div>
                <div class="chart-card p-6 rounded-3xl h-[200px]"><canvas id="chartBulanan"></canvas></div>
            </div>
            <div class="flex justify-center gap-2 mb-6">
                <button class="filter-btn active" onclick="filterPiket('ALL', this)">ALL</button>
                <button class="filter-btn" onclick="filterPiket('7', this)">KLS 7</button>
                <button class="filter-btn" onclick="filterPiket('8', this)">KLS 8</button>
                <button class="filter-btn" onclick="filterPiket('9', this)">KLS 9</button>
            </div>
            <div class="table-container overflow-x-auto">
                <table>
                    <thead><tr><th>No</th><th>Waktu</th><th>Kls</th><th>Nama</th><th>Alasan</th><th>Aksi</th></tr></thead>
                    <tbody id="piket_data"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxwNynndvjRnT6brfs6nCyJ_fqFuzyH1cmAJTQEsYfeff5Dbu-TmqIhl6YcYSadS5Tc9w/exec";
 
		const DAFTAR_AKSES = { "7A":"7 A","7B":"7 B","7C":"7 C","7D":"7 D","7E":"7 E","7F":"7 F","8A":"8 A","8B":"8 B","8C":"8 C","8D":"8 D","8E":"8 E","8F":"8 F","9A":"9 A","9B":"9 B","9C":"9 C","9D":"9 D","9E":"9 E","9F":"9 F","110":"ALL" };
        
        const WA_WALI = {
            "7 A": "628",
            "7 B": "628",
			"7 C": "628",
            "7 D": "628",
            "7 E": "628",
            "7 F": "628",			
            "8 A": "628",
            "8 B": "628",
			"8 C": "628",
            "8 D": "628",
            "8 E": "628",
            "8 F": "628567856766",
            "9 A": "628",
            "9 B": "628",
			"9 C": "628",
            "9 D": "628",
            "9 E": "628",
            "9 F": "628",			
        };

        let MASTER = [], RAW_PIKET = [], KELAS_AKTIF = "", chartH, chartB;

        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        async function verifyAccess(id, btn) {
            const { value: pin } = await Swal.fire({ title: 'PIN AKSES', input: 'password', customClass: { popup: 'swal2-popup-custom', input: 'input-kode' } });
            if (DAFTAR_AKSES[pin]) {
                KELAS_AKTIF = DAFTAR_AKSES[pin];
                showTab(id, btn);
                id === 'wali' ? loadWali() : loadPiket();
            } else if (pin) { Swal.fire('PIN SALAH', '', 'error'); }
        }

        async function loadMaster() {
            try {
                const r = await fetch(`${SCRIPT_URL}?mode=master`);
                const d = await r.json();
                MASTER = Object.entries(d).map(([nis, v]) => ({ nis, nama: v.nama, kelas: v.kelas }));
                const ks = document.getElementById('kelas_select');
                const kelasSet = [...new Set(MASTER.map(s => s.kelas))].sort();
                ks.innerHTML = '<option value="">-- pilih kelas --</option>' + kelasSet.map(k => `<option value="${k}">${k}</option>`).join('');
            } catch(e) { console.error("Error DB"); }
        }

        function filterNama() {
            const k = document.getElementById('kelas_select').value;
            const ns = document.getElementById('nama_murid');
            let filtered = MASTER.filter(s => s.kelas === k).sort((a,b) => a.nama.localeCompare(b.nama));
            ns.innerHTML = '<option value="">-- pilih nama --</option>' + filtered.map(s => `<option value="${s.nis}">${s.nama}</option>`).join('');
        }

        function isiDataSiswa() {
            document.getElementById('nis').value = document.getElementById('nama_murid').value;
        }

        document.getElementById('izinForm').onsubmit = async (e) => {
            e.preventDefault();
            const nis = document.getElementById('nama_murid').value;
            const s = MASTER.find(x => x.nis === nis);
            if(!s) return;

            Swal.fire({ title: 'Mengunggah Data...', allowOutsideClick: false, didOpen: () => Swal.showLoading(), customClass: { popup: 'swal2-popup-custom' } });

            // GENERATE PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const tgl = new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });
            
            doc.setFontSize(16).setFont("helvetica","bold").text("SURAT IZIN TIDAK MASUK SEKOLAH", 105, 25, { align: "center" });
            doc.setFontSize(11).setFont("helvetica","normal").text(`Kepada Yth, \nBapak/Ibu Wali Kelas ${s.kelas}\nSMPN 110 Jakarta\n\nSaya yang bertanda tangan di bawah ini, Orang Tua/Wali dari:\n\nNama  :  ${s.nama}\nNIS     :  ${s.nis}\nKelas  :  ${s.kelas}\n\nMenerangkan bahwa anak Kami tidak dapat masuk sekolah karena ${document.getElementById('alasan').value}.\nDemikian surat izin ini Kami sampaikan, atas perhatiannya Kami ucapkan terima kasih.\n\n\n\nJakarta, ${tgl}\nHormat Saya,\n\n\n\nOrang Tua/Wali`, 20, 50);
            
            const pdfBase64 = doc.output('datauristring').split(',')[1];

            const payload = {
                mode: "tambah_izin",
                kelas: s.kelas, nis: s.nis, nama_murid: s.nama,
                alasan: document.getElementById('alasan').value,
                nama_wali: document.getElementById('nama_wali').value,
                keterangan: document.getElementById('keterangan').value,
                pdfBase64: pdfBase64
            };

            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
                doc.save(`Izin_${s.nama}.pdf`);
                kirimWA(payload);
                Swal.fire({ icon: 'success', title: 'BERHASIL', text: 'Tersimpan di database sekolah.' });
                document.getElementById('izinForm').reset();
            } catch(err) { Swal.fire('Gagal Kirim', '', 'error'); }
        };

        function kirimWA(d) {
            const num = WA_WALI[d.kelas];
            if(num) {
                const txt = `*E-IZIN SMPN 110*%0A%0AYth. Bapak/Ibu Wali Kelas ${d.kelas},%0A%0ASaya Orang Tua/Wali dari:%0A%0A- Nama : ${d.nama_murid}%0A- Kelas : ${d.kelas}%0A%0AMemberitahukan bahwa anak kami tidak dapat masuk sekolah hari ini dikarenakan ${d.alasan},%0A%0ATerima kasih.%0A%0A*(Dikirim otomatis via E-Izin)*`;
                window.open(`https://wa.me/${num}?text=${txt}`, '_blank');
            }
        }

        async function loadWali() {
            const r = await fetch(`${SCRIPT_URL}?mode=izin&kelas=${KELAS_AKTIF}`);
            const data = await r.json();
            document.getElementById('wali_data').innerHTML = data.map((x, i) => `<tr><td>${i+1}</td><td>${x.tanggal}</td><td>${x.nama}</td><td>${x.alasan}</td><td><a href="${x.pdfUrl}" target="_blank">üìÑ</a></td></tr>`).join('');
        }

        async function loadPiket() {
            const r = await fetch(`${SCRIPT_URL}?mode=piket`);
            RAW_PIKET = await r.json();
            filterPiket('ALL', document.querySelector('.filter-btn.active'));
        }

        function filterPiket(t, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            let f = (t === 'ALL') ? RAW_PIKET : RAW_PIKET.filter(i => i.kelas.startsWith(t));
            document.getElementById('piket_data').innerHTML = f.map((x, i) => `<tr><td>${i+1}</td><td>${x.tanggal}</td><td>${x.kelas}</td><td>${x.nama}</td><td>${x.alasan}</td><td><a href="${x.pdfUrl}" target="_blank">üìÑ</a> <button onclick="hapusRow(${x.row})">üóëÔ∏è</button></td></tr>`).join('');
        }

        async function hapusRow(r) {
            if (confirm('Hapus data?')) {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ mode: "delete", row: r }) });
                loadPiket();
            }
        }

        function toggleGrafik() { 
            document.getElementById('section-grafik').classList.toggle('hidden'); 
            if(!document.getElementById('section-grafik').classList.contains('hidden')) updateCharts(RAW_PIKET);
        }

        function updateCharts(data) {
            const h = {}, b = {};
            data.forEach(item => {
                const d = item.tanggal.split(' ')[0], m = d.split('/')[1];
                h[d] = (h[d] || 0) + 1; b[m] = (b[m] || 0) + 1;
            });
            const cfg = (ctx, l, d, c) => new Chart(ctx, { type: 'line', data: { labels: l, datasets: [{ data: d, borderColor: c, tension: 0.4 }] }, options: { maintainAspectRatio: false } });
            if(chartH) chartH.destroy(); if(chartB) chartB.destroy();
            chartH = cfg(document.getElementById('chartHarian'), Object.keys(h), Object.values(h), '#22d3ee');
            chartB = cfg(document.getElementById('chartBulanan'), Object.keys(b), Object.values(b), '#f43f5e');
        }

        window.onload = loadMaster;
    </script>
</body>
</html>