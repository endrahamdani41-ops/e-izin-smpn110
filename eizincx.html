<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-IZIN 110 | PIKET FILTER SYSTEM</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #060a16; color: white; min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .btn-indigo { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); transition: 0.3s; }
    .hidden-section { display: none !important; }
    .input-upper { text-transform: uppercase; }

    table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.3); border: 1px solid #334155; }
    th { background: rgba(99, 102, 241, 0.4); color: white; padding: 10px; border: 1px solid #475569; font-size: 11px; text-transform: uppercase; }
    td { padding: 8px; border: 1px solid #334155; font-size: 12px; text-align: center; }
    
    input, select, textarea { 
        background: #0f172a !important; border: 1px solid #334155 !important; 
        color: white !important; border-radius: 0.5rem !important; text-align: center; width: 100%;
    }
  </style>
</head>
<body class="p-4 flex flex-col items-center">

  <div id="loginPage" class="w-full max-w-md my-auto pt-10">
    <div class="glass p-10 rounded-[3rem] text-center border-t-4 border-indigo-500 shadow-2xl">
      <div class="flex justify-center mb-4">
        <img src="https://i.ibb.co.com/MDTybQJn/LOGO-CX-OK.png" alt="Logo Sekolah" class="h-24 w-auto drop-shadow-lg">
      </div>
      
      <h1 class="text-3xl font-black uppercase italic tracking-tighter mb-6">E - I Z I N</h1>
	  <h1>SMPN 110 JAKARTA</h1><br>
      <input type="text" id="loginInput" placeholder="MASUKKAN NIS / USERNAME" class="p-4 mb-4 font-bold input-upper" autocomplete="off">
      <button onclick="handleLogin()" id="loginBtn" class="w-full p-4 rounded-2xl btn-indigo font-black uppercase">Masuk</button>
    </div>
  </div>

  <div id="siswaDashboard" class="hidden-section w-full max-w-lg space-y-6 pt-6">
    <div class="glass p-6 rounded-[2rem] flex justify-between items-center border-l-8 border-indigo-500">
      <div>
        <h2 id="siswaName" class="text-lg font-bold uppercase">...</h2>
        <p id="siswaKelasLabel" class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest"></p>
      </div>
      <button onclick="location.reload()" class="p-3 bg-rose-500/10 text-rose-500 rounded-xl"><i data-lucide="power"></i></button>
    </div>
    <div id="formIzinSiswa" class="glass p-8 rounded-[2.5rem] space-y-5 shadow-2xl">
      <input type="text" id="namaOrtu" placeholder="NAMA ORANG TUA" class="p-4 font-bold uppercase">
      <select id="alasanIzin" class="p-4 font-bold">
        <option value="Sakit">Sakit</option>
        <option value="Izin Keperluan">Izin Keperluan</option>
      </select>
      <textarea id="ketIzin" class="p-4 h-24 text-center" placeholder="Sebutkan detail alasan di sini..."></textarea>
      <button onclick="konfirmasiKirim()" class="w-full p-5 rounded-2xl btn-indigo font-black uppercase">Kirim Laporan</button>
    </div>
  </div>

  <div id="waliDashboard" class="hidden-section w-full max-w-5xl space-y-6">
    <div class="glass p-8 rounded-[2rem] flex justify-between items-center border-l-[10px] border-indigo-600 shadow-xl">
      <div>
        <h2 class="text-3xl font-black italic uppercase"><span id="titleRole">KELAS</span> <span id="labelKelas" class="text-indigo-500"></span></h2>
        <p id="waliName" class="text-[10px] text-indigo-300 font-bold uppercase tracking-widest"></p>
        <div id="saveStatus" class="text-emerald-500 font-bold text-[9px] uppercase mt-1">● Status: Siaga</div>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleViewWali('hariIni')" class="p-4 bg-indigo-500/20 text-indigo-400 rounded-xl"><i data-lucide="calendar-check"></i></button>
        <button onclick="toggleViewWali('rekap')" class="p-4 bg-amber-500/20 text-amber-400 rounded-xl"><i data-lucide="database"></i></button>
        <button onclick="location.reload()" class="p-4 bg-rose-500/20 text-rose-500 rounded-xl"><i data-lucide="power"></i></button>
      </div>
    </div>

    <div id="sectionHariIni" class="glass p-6 rounded-[2rem] border-t-4 border-indigo-400">
      <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
        <div class="text-indigo-400 font-bold uppercase text-xs italic">Laporan Masuk Hari Ini</div>
        
        <div id="piketFilterContainer" class="hidden-section w-full md:w-48">
          <select id="filterJenjang" onchange="applyFilter()" class="p-2 text-xs font-bold border-indigo-500/30">
            <option value="all">SEMUA KELAS</option>
            <option value="7">KELAS 7</option>
            <option value="8">KELAS 8</option>
            <option value="9">KELAS 9</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table>
            <thead>
              <tr>
                <th>No</th>
                <th>NIS</th>
                <th>Nama Siswa</th>
                <th>Kelas</th>
                <th>Status</th>
                <th>Keterangan</th>
              </tr>
            </thead>
            <tbody id="hariIniBodyWali"></tbody>
        </table>
      </div>
    </div>

    <div id="sectionRekap" class="hidden-section glass p-6 rounded-[2rem] border-t-4 border-amber-400">
      <div class="flex justify-between items-center mb-4">
        <div class="text-amber-400 font-bold uppercase text-xs italic">Data Rekap Kumulatif</div>
        <button onclick="cetakRekapPDF()" class="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg text-[10px] font-bold border border-emerald-500/30 flex gap-2"><i data-lucide="printer" class="w-4 h-4"></i></button>
      </div>
      <div class="overflow-x-auto">
        <table id="tableRekapUtama">
            <thead>
              <tr>
                <th>No</th>
                <th>NIS</th>
                <th>Nama Siswa</th>
                <th>Kelas</th>
                <th>S</th>
                <th>I</th>
                <th class="text-rose-400">A</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="rekapBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxB7YdqjkW9l9HQ6qbI2ow7-JOroGVsXs1ExdW7uJmBXvjTKRNjOVh4nxvuIPSEzMRlxA/exec"; 
    let userAktif = null;
    let dataHariIniGlobal = []; // Menyimpan data asli untuk difilter
    let saveTimeout = null;

    lucide.createIcons();

    async function handleLogin() {
      const input = document.getElementById('loginInput').value.trim().toUpperCase();
      if (!input) return;
      try {
        const res = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(input)}`);
        const data = await res.json();
        if (data.status === "success") {
          userAktif = data.user;
          document.getElementById('loginPage').classList.add('hidden-section');
          if (userAktif.role === 'siswa') {
            document.getElementById('siswaDashboard').classList.remove('hidden-section');
            document.getElementById('siswaName').innerText = userAktif.nama;
            document.getElementById('siswaKelasLabel').innerText = "NIS: " + userAktif.nis + " | KELAS: " + userAktif.kelas;
          } else {
            document.getElementById('waliDashboard').classList.remove('hidden-section');
            document.getElementById('labelKelas').innerText = userAktif.kelas;
            document.getElementById('titleRole').innerText = userAktif.kelas === "110" ? "PIKET" : "KELAS";
            document.getElementById('waliName').innerText = "USER: " + userAktif.nama;
            
            // Tampilkan dropdown filter jika user adalah Piket
            if(userAktif.kelas === "7, 8, 9") {
              document.getElementById('piketFilterContainer').classList.remove('hidden-section');
            }
            
            loadDataWali();
          }
          lucide.createIcons();
        } else { Swal.fire('Gagal', 'User tidak ditemukan', 'error'); }
      } catch (e) { Swal.fire('Error', 'Gagal terhubung ke server', 'error'); }
    }

    async function loadDataWali() {
      const [resH, resR] = await Promise.all([
        fetch(`${API_URL}?action=getIzinHariIni&kelas=${encodeURIComponent(userAktif.kelas)}`),
        fetch(`${API_URL}?action=getAdminData&kelas=${encodeURIComponent(userAktif.kelas)}`)
      ]);
      dataHariIniGlobal = await resH.json();
      const dataR = await resR.json();

      renderTabelHariIni(dataHariIniGlobal);
      renderTabelRekap(dataR);
    }

    function renderTabelHariIni(data) {
      document.getElementById('hariIniBodyWali').innerHTML = data.map((s, i) => `
        <tr>
          <td>${i+1}</td>
          <td class="font-mono text-[10px] text-indigo-300">${s.nis}</td>
          <td class="text-left font-bold uppercase">${s.nama}</td>
          <td class="font-bold text-amber-400 text-[10px]">${s.kelas_siswa}</td>
          <td>${s.status}</td>
          <td class="italic text-[10px]">${s.keterangan}</td>
        </tr>`).join('');
    }

    function applyFilter() {
      const filterValue = document.getElementById('filterJenjang').value;
      if (filterValue === "all") {
        renderTabelHariIni(dataHariIniGlobal);
      } else {
        // Filter data berdasarkan karakter pertama dari nama kelas (misal: "7A" -> "7")
        const filtered = dataHariIniGlobal.filter(s => s.kelas_siswa.toString().startsWith(filterValue));
        renderTabelHariIni(filtered);
      }
    }

    function renderTabelRekap(data) {
      document.getElementById('rekapBody').innerHTML = data.map((s, i) => `
        <tr data-nis="${s.nis}">
          <td>${i+1}</td>
          <td class="font-mono text-[10px] text-slate-400">${s.nis}</td>
          <td class="text-left font-bold uppercase">${s.nama}</td>
          <td class="text-amber-400 font-bold text-[10px]">${s.kelas_siswa}</td>
          <td><input type="number" class="w-10 val-s" value="${s.rekap?.S || 0}" oninput="autoSave(this)"></td>
          <td><input type="number" class="w-10 val-i" value="${s.rekap?.I || 0}" oninput="autoSave(this)"></td>
          <td><input type="number" class="w-10 val-a text-rose-400" value="${s.rekap?.A || 0}" oninput="autoSave(this)"></td>
          <td class="row-total font-black text-indigo-400">${(parseInt(s.rekap?.S)||0)+(parseInt(s.rekap?.I)||0)+(parseInt(s.rekap?.A)||0)}</td>
        </tr>`).join('');
    }

    function autoSave(input) {
      const tr = input.closest('tr');
      tr.querySelector('.row-total').innerText = (parseInt(tr.querySelector('.val-s').value)||0) + (parseInt(tr.querySelector('.val-i').value)||0) + (parseInt(tr.querySelector('.val-a').value)||0);
      document.getElementById('saveStatus').innerText = "● Menyimpan...";
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        const rows = Array.from(document.querySelectorAll('#rekapBody tr')).map(r => ({
          nis: r.dataset.nis, s: r.querySelector('.val-s').value, i: r.querySelector('.val-i').value, a: r.querySelector('.val-a').value
        }));
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateBulkAbsen', data: rows }) });
        document.getElementById('saveStatus').innerText = "● Data Tersimpan";
      }, 1500);
    }

    function toggleViewWali(view) {
      document.getElementById('sectionHariIni').classList.toggle('hidden-section', view !== 'hariIni');
      document.getElementById('sectionRekap').classList.toggle('hidden-section', view !== 'rekap');
    }

    function cetakRekapPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const tglSekarang = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
      doc.setFontSize(14);
      doc.text(`REKAPITULASI ABSENSI ${userAktif.kelas === '110' ? 'SELURUH KELAS' : 'KELAS ' + userAktif.kelas}`, 105, 15, { align: 'center' });
      doc.autoTable({
        html: '#tableRekapUtama',
        startY: 22,
        theme: 'grid',
        styles: { fontSize: 7.5, cellPadding: 1.5, halign: 'center', lineColor: [0, 0, 0], lineWidth: 0.2, textColor: [0, 0, 0] },
        headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' },
        columnStyles: { 0: { cellWidth: 8 }, 1: { cellWidth: 18 }, 2: { halign: 'left', cellWidth: 'auto' }, 3: { cellWidth: 15 }, 4: { cellWidth: 8 }, 5: { cellWidth: 8 }, 6: { cellWidth: 8 }, 7: { cellWidth: 10 } },
        didParseCell: (d) => { if(d.section === 'body') { const inp = d.cell.raw.querySelector('input'); if(inp) d.cell.text = inp.value; } }
      });
      const finalY = doc.lastAutoTable.finalY + 8;
      doc.setFontSize(10);
      doc.text(`Jakarta, ${tglSekarang}`, 140, finalY);
      doc.text(`${userAktif.role === 'piket' || userAktif.kelas === '110' ? 'Petugas Piket' : 'Wali Kelas ' + userAktif.kelas},`, 140, finalY + 5);
      doc.setFont("helvetica", "bold");
      doc.text(userAktif.nama, 140, finalY + 25);
      doc.line(140, finalY + 26, 185, finalY + 26);
      doc.save(`Rekap_Absensi.pdf`);
    }

    async function konfirmasiKirim() {
      const ortu = document.getElementById('namaOrtu').value.trim();
      const ket = document.getElementById('ketIzin').value.trim();
      if(!ortu || !ket) return Swal.fire('Lengkapi Data', '', 'warning');
      const p = new URLSearchParams({ action: 'submitIzin', nis: userAktif.nis, nama_siswa: userAktif.nama, kelas: userAktif.kelas, alasan: document.getElementById('alasanIzin').value, keterangan: ket, nama_ortu: ortu });
      await fetch(`${API_URL}?${p.toString()}`);
      location.reload();
    }
  </script>
</body>
</html>