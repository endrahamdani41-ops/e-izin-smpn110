<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-IZIN 110 | NEON LOGIN</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #030712; color: white; min-height: 100vh; margin: 0; overflow-x: hidden; }
    #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
    
    /* EFEK GARIS MENYALA PADA KOTAK LOGIN */
    .neon-box {
      border: 2px solid #6366f1;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.5), 
                  0 0 20px rgba(99, 102, 241, 0.3), 
                  inset 0 0 15px rgba(99, 102, 241, 0.2);
      animation: neonPulse 2s infinite alternate;
    }

    @keyframes neonPulse {
      from { 
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.4), 0 0 20px rgba(99, 102, 241, 0.2); 
        border-color: rgba(99, 102, 241, 0.6);
      }
      to { 
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.8), 0 0 40px rgba(99, 102, 241, 0.4); 
        border-color: rgba(99, 102, 241, 1);
      }
    }

    .solid-bg { background: #0f172a !important; border: 2px solid #334155; }
    
    .btn-3d-pushable { position: relative; background: #3730a3; border-radius: 1rem; border: none; padding: 0; cursor: pointer; width: 100%; }
    .btn-3d-front { display: block; position: relative; padding: 1rem; border-radius: 1rem; font-size: 1.1rem; color: white; background: #6366f1; transform: translateY(-6px); transition: transform 34ms; }
    .btn-3d-pushable:active .btn-3d-front { transform: translateY(-2px); }
    .hidden-section { display: none !important; }
    
    input, select, textarea { 
      background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; 
      border-radius: 0.8rem; padding: 10px; width: 100%; text-align: center; 
    }
    input::placeholder, textarea::placeholder { text-align: center; }

    .table-container { overflow-x: auto; width: 100%; border-radius: 1rem; }
    table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.4); border: 1px solid #334155; }
    th, td { padding: 12px 15px; border: 1px solid #334155; font-size: 12px; text-align: center; }
    th { background: #1e1b4b; color: white; }
    .col-nama { text-align: center !important; min-width: 220px; font-weight: 600; }
  </style>
</head>
<body class="p-4 flex flex-col items-center">

  <canvas id="starCanvas"></canvas>

  <div id="loginPage" class="w-full max-w-md my-auto pt-20">
    <div class="glass neon-box p-10 rounded-[3rem] text-center">
      <img src="https://i.ibb.co.com/MDTybQJn/LOGO-CX-OK.png" class="h-24 mx-auto mb-4">
      <h1 class="text-3xl font-black italic mb-6 text-indigo-400">E-IZIN 110</h1>
      <input type="text" id="loginInput" placeholder="NIS / USERNAME" class="font-bold uppercase outline-none">
      <div class="mt-6">
        <button onclick="handleLogin()" class="btn-3d-pushable"><span class="btn-3d-front font-black uppercase">Masuk</span></button>
      </div>
    </div>
  </div>

  <div id="siswaDashboard" class="hidden-section w-full max-w-lg space-y-6">
    <div class="glass p-8 rounded-[3rem] text-center border-t-[10px] border-indigo-600 shadow-xl">
      <h2 class="text-2xl font-black italic uppercase" id="siswaName">NAMA SISWA</h2>
      <p id="siswaKelas" class="text-indigo-400 font-bold mb-6"></p>
      
      <div id="formKontenSiswa" class="text-left space-y-4">
        <div><label class="text-[10px] font-bold block text-center uppercase mb-1">Alasan Izin</label>
          <select id="alasanIzin"><option value="Sakit">Sakit</option><option value="Izin">Izin</option></select>
        </div>
        <div><label class="text-[10px] font-bold block text-center uppercase mb-1">Nama Orang Tua</label>
          <input type="text" id="namaOrtu" placeholder="Nama Lengkap Orang Tua">
        </div>
        <div><label class="text-[10px] font-bold block text-center uppercase mb-1">Keterangan</label>
          <textarea id="ketIzin" placeholder="Jelaskan detail alasan di sini..." class="h-24"></textarea>
        </div>
        <button onclick="konfirmasiKirim()" class="btn-3d-pushable"><span class="btn-3d-front font-black uppercase">Kirim Laporan</span></button>
        <button onclick="location.reload()" class="w-full text-rose-500 font-bold text-sm mt-4">LOGOUT</button>
      </div>
    </div>
  </div>

  <div id="waliDashboard" class="hidden-section w-full max-w-6xl space-y-6">
    <div class="glass p-8 rounded-[3rem] flex flex-col items-center text-center border-t-[10px] border-indigo-600">
      <h2 class="text-4xl font-black italic uppercase"><span id="titleRole">KELAS</span> <span id="labelKelas" class="text-indigo-500"></span></h2>
      <p id="waliName" class="text-[11px] text-indigo-300 font-bold mt-2 uppercase"></p>
      
      <div class="flex flex-wrap justify-center gap-4 mt-8">
        <button onclick="switchTable()" title="Tukar Tabel" class="p-5 bg-indigo-500/20 text-indigo-400 rounded-2xl border border-indigo-500/20 hover:scale-110 transition-transform"><i data-lucide="arrow-left-right"></i></button>
        <button id="btnGrafik" onclick="toggleViewWali('grafik')" title="Grafik" class="hidden-section p-5 bg-emerald-500/20 text-emerald-400 rounded-2xl border border-emerald-500/20 hover:scale-110 transition-transform"><i data-lucide="bar-chart-3"></i></button>
        <button onclick="location.reload()" title="Logout" class="p-5 bg-rose-500/20 text-rose-500 rounded-2xl border border-rose-500/20 hover:scale-110 transition-transform"><i data-lucide="power"></i></button>
      </div>
    </div>

    <div id="sectionGrafik" class="hidden-section"><div class="glass p-8 rounded-[3rem]" style="height: 450px;"><canvas id="chartIzin"></canvas></div></div>

    <div id="sectionHariIni" class="glass p-6 rounded-[2.5rem] border-t-4 border-indigo-400">
      <h3 class="text-sm font-bold text-indigo-400 mb-4 uppercase italic text-center">Laporan Hari Ini</h3>
      <div class="table-container"><table><thead><tr><th>No</th><th>NIS</th><th class="col-nama">Nama</th><th>Kelas</th><th>Status</th><th>Keterangan</th></tr></thead><tbody id="hariIniBodyWali"></tbody></table></div>
    </div>

    <div id="sectionRekap" class="hidden-section solid-bg p-8 rounded-[3rem]">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-black text-amber-400 uppercase italic">Rekap Kumulatif</h3>
        <button onclick="cetakRekapPDF()" class="p-2 bg-emerald-600 text-white rounded-lg text-xs font-bold px-4 flex gap-2"><i data-lucide="printer" class="w-4 h-4"></i> CETAK PDF F4</button>
      </div>
      <div class="table-container"><table id="tableRekapUtama"><thead><tr><th>No</th><th>NIS</th><th class="col-nama">Nama Siswa</th><th>Kelas</th><th>S</th><th>I</th><th>A</th><th>Total</th></tr></thead><tbody id="rekapBody"></tbody></table></div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxB7YdqjkW9l9HQ6qbI2ow7-JOroGVsXs1ExdW7uJmBXvjTKRNjOVh4nxvuIPSEzMRlxA/exec"; 
 
    let userAktif = null;
    let dataHariIniGlobal = [];
    let currentTableView = 'hariIni';
    let myChart = null;

    async function handleLogin() {
      const input = document.getElementById('loginInput').value.trim().toUpperCase();
      if (!input) return;
      try {
        const res = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(input)}`);
        const data = await res.json();
        if (data.status === "success") {
          userAktif = data.user;
          document.getElementById('loginPage').classList.add('hidden-section');
          if (userAktif.role === "siswa") {
              document.getElementById('siswaDashboard').classList.remove('hidden-section');
              document.getElementById('siswaName').innerText = userAktif.nama;
              document.getElementById('siswaKelas').innerText = "KELAS " + userAktif.kelas;
              const today = new Date().toDateString();
              if (localStorage.getItem(`izin_${userAktif.nis}_${today}`)) {
                document.getElementById('formKontenSiswa').innerHTML = `<div class='p-6 bg-emerald-500/10 border border-emerald-500/30 rounded-2xl text-center'><i data-lucide='check-circle' class='mx-auto mb-2 text-emerald-500'></i><p class='text-sm font-bold text-emerald-400 uppercase'>Laporan Sudah Terkirim Hari Ini.</p></div><button onclick='location.reload()' class='w-full text-rose-500 font-bold text-sm mt-6'>LOGOUT</button>`;
              }
          } else {
              document.getElementById('waliDashboard').classList.remove('hidden-section');
              document.getElementById('labelKelas').innerText = userAktif.kelas;
              document.getElementById('waliName').innerText = userAktif.nama;
              if(userAktif.kelas === "110" || userAktif.kelas === "7, 8, 9") {
                  document.getElementById('titleRole').innerText = "PIKET";
                  document.getElementById('btnGrafik').classList.remove('hidden-section');
              }
              loadData();
          }
          lucide.createIcons();
        } else { Swal.fire('Error', 'User tidak ditemukan', 'error'); }
      } catch (e) { Swal.fire('Error', 'Gagal Koneksi', 'error'); }
    }

    async function loadData() {
      const [resH, resR] = await Promise.all([
        fetch(`${API_URL}?action=getIzinHariIni&kelas=${encodeURIComponent(userAktif.kelas)}`),
        fetch(`${API_URL}?action=getAdminData&kelas=${encodeURIComponent(userAktif.kelas)}`)
      ]);
      dataHariIniGlobal = await resH.json();
      renderHariIni(dataHariIniGlobal);
      renderRekap(await resR.json());
    }

    function renderHariIni(data) {
      document.getElementById('hariIniBodyWali').innerHTML = data.map((s, i) => `<tr><td>${i+1}</td><td>${s.nis}</td><td class='font-bold'>${s.nama}</td><td>${s.kelas_siswa}</td><td>${s.status}</td><td>${s.keterangan}</td></tr>`).join('');
    }

    function renderRekap(data) {
      document.getElementById('rekapBody').innerHTML = data.map((s, i) => {
        const t = (parseInt(s.rekap?.S)||0) + (parseInt(s.rekap?.I)||0) + (parseInt(s.rekap?.A)||0);
        return `<tr><td>${i+1}</td><td>${s.nis}</td><td class='font-bold'>${s.nama}</td><td>${s.kelas_siswa}</td><td>${s.rekap?.S||0}</td><td>${s.rekap?.I||0}</td><td>${s.rekap?.A||0}</td><td class='text-indigo-400 font-bold'>${t}</td></tr>`;
      }).join('');
    }

    function switchTable() {
      currentTableView = currentTableView === 'hariIni' ? 'rekap' : 'hariIni';
      toggleViewWali(currentTableView);
    }

    function toggleViewWali(view) {
      document.getElementById('sectionHariIni').classList.toggle('hidden-section', view !== 'hariIni');
      document.getElementById('sectionRekap').classList.toggle('hidden-section', view !== 'rekap');
      document.getElementById('sectionGrafik').classList.toggle('hidden-section', view !== 'grafik');
      if(view === 'grafik') setTimeout(updateChart, 100);
    }

    function updateChart() {
      const k7 = dataHariIniGlobal.filter(s => s.kelas_siswa.toString().startsWith('7')).length;
      const k8 = dataHariIniGlobal.filter(s => s.kelas_siswa.toString().startsWith('8')).length;
      const k9 = dataHariIniGlobal.filter(s => s.kelas_siswa.toString().startsWith('9')).length;
      const ctx = document.getElementById('chartIzin').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['KELAS 7', 'KELAS 8', 'KELAS 9'],
          datasets: [{
            data: [k7, k8, k9],
            backgroundColor: ['#6366f1', '#f59e0b', '#10b981'],
            borderRadius: 15
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    async function konfirmasiKirim() {
      const ortu = document.getElementById('namaOrtu').value.trim();
      const ket = document.getElementById('ketIzin').value.trim();
      if(!ortu || !ket) return Swal.fire('Lengkapi Data', '', 'warning');
      Swal.fire({ title: 'Kirim Izin?', icon: 'question', showCancelButton: true }).then(async (res) => {
        if(res.isConfirmed) {
          const p = new URLSearchParams({ action: 'submitIzin', nis: userAktif.nis, nama_siswa: userAktif.nama, kelas: userAktif.kelas, alasan: document.getElementById('alasanIzin').value, keterangan: ket, nama_ortu: ortu });
          await fetch(`${API_URL}?${p.toString()}`);
          localStorage.setItem(`izin_${userAktif.nis}_${new Date().toDateString()}`, "true");
          Swal.fire('Berhasil', '', 'success').then(() => location.reload());
        }
      });
    }

    function cetakRekapPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', [215.9, 330.2]); 
      const tgl = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
      doc.setFontSize(14).setFont(undefined, 'bold').text("REKAPITULASI KEHADIRAN SISWA", 107.9, 15, { align: 'center' });
      doc.autoTable({ 
        html: '#tableRekapUtama', startY: 28, theme: 'grid',
        styles: { fontSize: 8.5, halign: 'center' },
        headStyles: { fillColor: [30, 27, 75], halign: 'center' },
        didDrawPage: (data) => {
          const finalY = data.cursor.y + 15;
          doc.text(`Jakarta, ${tgl}`, 135, finalY);
          doc.text("Wali Kelas,", 135, finalY + 6);
          doc.setFont(undefined, 'bold').text(userAktif.nama, 135, finalY + 22);
        
        }
      });
      doc.save(`Rekap_${userAktif.kelas}.pdf`);
    }

    const sCanvas = document.getElementById('starCanvas');
    const sCtx = sCanvas.getContext('2d');
    let stars = [];
    function initStars() {
      sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight;
      stars = []; for (let i = 0; i < 150; i++) stars.push({ x: Math.random() * sCanvas.width, y: Math.random() * sCanvas.height, size: Math.random() * 1.5, speed: Math.random() * 0.5 + 0.2 });
    }
    function drawStars() {
      sCtx.clearRect(0, 0, sCanvas.width, sCanvas.height);
      sCtx.fillStyle = "white";
      for (let s of stars) { sCtx.beginPath(); sCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2); sCtx.fill(); s.y += s.speed; if (s.y > sCanvas.height) s.y = -5; }
      requestAnimationFrame(drawStars);
    }
    window.addEventListener('resize', initStars); initStars(); drawStars();
    lucide.createIcons();
  </script>
</body>
</html>
