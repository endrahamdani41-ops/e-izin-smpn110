<!doctype html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Izin v5.15 - SMPN 110 Jakarta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --glass: rgba(15, 23, 42, 0.85); --text: #f8fafc; --border: rgba(255, 255, 255, 0.2); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); transition: 0.4s; }
        .glass { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--border); border-radius: 2rem; }
        
        /* Gaya Tabel: Semua Rata Tengah & Border Tegas */
        table { border-collapse: collapse; width: 100%; border: 1px solid var(--border) !important; }
        th, td { 
            border: 1px solid var(--border) !important; 
            padding: 12px 8px; 
            text-align: center; 
            vertical-align: middle;
        }
        th { background: rgba(255, 255, 255, 0.05); }

        .modal-overlay { position: fixed; inset: 0; z-index: 5000; background: rgba(2, 6, 23, 0.4); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.4s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .select-none { -webkit-user-select: none; user-select: none; }
        
        .toast-item { animation: toastSlide 0.5s forwards; }
        @keyframes toastSlide { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast-stack" class="fixed top-6 right-6 z-[6000] flex flex-col gap-3"></div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="glass p-8 w-[90%] max-w-[340px] text-center shadow-2xl">
            <h3 id="confirm-title" class="text-xl font-extrabold uppercase mb-2 text-indigo-400">Konfirmasi</h3>
            <p id="confirm-msg" class="text-xs opacity-60 mb-8 px-2"></p>
            <div class="flex flex-col gap-3">
                <button id="confirm-btn-ok" class="btn-primary w-full py-4 rounded-2xl text-white text-[11px] font-black uppercase tracking-widest">Ya, Lanjutkan</button>
                <button onclick="closeConfirm(false)" class="w-full py-3 rounded-2xl text-[10px] font-bold uppercase opacity-50">Batalkan</button>
            </div>
        </div>
    </div>

    <div id="login-page" class="flex items-center justify-center min-h-screen p-6">
        <div class="glass p-10 w-full max-w-md text-center shadow-2xl">
            <img src="https://chatgpt.com/backend-api/estuary/public_content/enc/eyJpZCI6Im1fNjk2MzllNWZhNTZjODE5MWJkZGFlM2FjYmNiYjJkZGY6ZmlsZV8wMDAwMDAwMDQ3OWM3MWZkOWRhNWViYmRkMzlmZTgwMSIsInRzIjoiMjA0NjQiLCJwIjoicHlpIiwiY2lkIjoiMSIsInNpZyI6IjIxNGE4ODVkMGI5ODg5OTMzMjIxMThiZjRjZTcwY2JhZDAwMzcwYjk1ZjRmOTI2MjM2ZDEzZjY1ZDNmMTRiZjQiLCJ2IjoiMCIsImdpem1vX2lkIjpudWxsLCJjcyI6bnVsbCwiY3AiOm51bGwsIm1hIjpudWxsfQ==" alt="Logo" class="w-20 h-20 mx-auto mb-6">
            <h1 class="text-2xl font-black mb-2 uppercase tracking-tighter">E-IZIN 110</h1>
            <input type="password" id="pass-input" placeholder="KODE AKSES" class="w-full p-4 rounded-2xl bg-black/20 border border-white/10 text-center font-bold tracking-[0.3em] mb-4 outline-none text-white uppercase">
            <button onclick="handleLogin()" class="btn-primary w-full py-4 rounded-2xl text-white font-black uppercase text-xs tracking-widest active:scale-95 transition-all">Masuk</button>
            <div id="login-status" class="mt-6 text-[10px] font-bold text-indigo-400 uppercase opacity-0">SINKRONISASI...</div>
        </div>
    </div>

    <div id="main-app" class="hidden p-4 max-w-6xl mx-auto w-full pb-20">
        <header class="flex flex-col items-center mb-8 glass p-8 text-center shadow-xl">
            <h2 id="user-display" class="font-black text-2xl uppercase mb-1"></h2>
            <p id="user-role-label" class="text-[10px] text-indigo-400 font-black uppercase mb-6 tracking-[0.3em]"></p>
            <div class="flex gap-4">
                <button id="btn-rekap" onclick="openRekap()" class="hidden w-12 h-12 glass flex items-center justify-center text-emerald-400 hover:scale-110 transition-all">ðŸ“Š</button>
                <button onclick="syncData()" class="w-12 h-12 glass flex items-center justify-center text-indigo-400 hover:scale-110 transition-all">â†»</button>
                <button onclick="triggerLogout()" class="w-12 h-12 glass flex items-center justify-center text-red-400 hover:scale-110 transition-all">âœ•</button>
            </div>
        </header>

        <div id="view-admin" class="hidden glass overflow-hidden mb-6 shadow-2xl">
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th class="text-[9px] font-black opacity-40">NO</th>
                            <th class="text-[9px] font-black opacity-40">WAKTU</th>
                            <th class="text-[9px] font-black opacity-40">NAMA SISWA</th>
                            <th class="text-[9px] font-black opacity-40">ALASAN</th>
                            <th class="text-[9px] font-black opacity-40">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="table-admin-body" class="text-[11px]"></tbody>
                </table>
            </div>
        </div>

        <div id="view-siswa" class="hidden glass p-8">
            <form onsubmit="saveIzin(event)" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <input type="text" id="ortu-name" placeholder="NAMA ORANG TUA" required class="p-4 rounded-2xl bg-black/20 border border-white/10 text-white font-bold text-xs uppercase outline-none">
                <select id="alasan-izin" class="p-4 rounded-2xl bg-black/20 border border-white/10 text-white text-xs font-bold outline-none cursor-pointer uppercase">
                    <option value="Sakit">SAKIT</option>
                    <option value="Izin Penting">IZIN PENTING</option>
                </select>
                <input type="text" id="ket-izin" placeholder="KETERANGAN" required class="p-4 rounded-2xl bg-black/20 border border-white/10 text-white text-xs outline-none uppercase">
                <button type="submit" id="btn-submit" class="md:col-span-3 btn-primary py-5 rounded-2xl text-white font-black uppercase text-[11px] tracking-widest mt-4">KIRIM SURAT</button>
            </form>
        </div>
    </div>

    <div id="rekap-modal" class="modal-overlay">
        <div class="glass p-6 w-[96%] max-w-4xl max-h-[85vh] overflow-hidden flex flex-col relative shadow-3xl">
            <div class="flex justify-between items-start mb-6 px-2">
                <button onclick="downloadRekapPDF()" class="w-10 h-10 flex items-center justify-center text-orange-400 glass hover:bg-orange-500/10 transition-all">ðŸ“„</button>
                <div class="text-center">
                    <h3 class="text-xl font-black uppercase text-white tracking-widest mb-1">SMPN 110 JAKARTA</h3>
                    <h3 class="text-xl font-black uppercase text-emerald-400 tracking-widest">REKAPITULASI ABSENSI</h3>
                </div>
                <button onclick="closeRekap()" class="w-10 h-10 flex items-center justify-center text-white/20 hover:text-red-400 font-bold text-xl transition-all">âœ•</button>
            </div>
            <div class="overflow-y-auto rounded-xl">
                <table>
                    <thead class="sticky top-0 bg-[#0f172a] z-10">
                        <tr>
                            <th class="text-[9px] font-black opacity-40">NO</th>
                            <th class="text-[9px] font-black opacity-40">NAMA SISWA</th>
                            <th class="text-[9px] font-black opacity-40 text-orange-400">S</th>
                            <th class="text-[9px] font-black opacity-40 text-indigo-400">I</th>
                            <th class="text-[9px] font-black opacity-40 text-red-400">A</th>
                            <th class="text-[9px] font-black opacity-40 text-emerald-400">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="rekap-body" class="text-[11px]"></tbody>
                </table>
            </div>
            <p class="text-[8px] text-center mt-4 opacity-40 uppercase font-bold tracking-widest">KLIK A UNTUK +1 â€¢ TAHAN LAMA UNTUK RESET DATA</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzJK_skUPLMDdbfOFLmLuigRTta1GOyubQfp8UM_voeAWCNKT2Bo_5pbOfX6x_OPvNl/exec"; 
        
        let cloudData = { izin: [], alpha: [], siswa: {} };
        let isDataLoaded = false;
        let confirmPromiseResolve;
        let pressTimer;

        async function showConfirm(title, msg) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-modal').classList.add('active');
            return new Promise((resolve) => {
                confirmPromiseResolve = resolve;
                document.getElementById('confirm-btn-ok').onclick = () => {
                    document.getElementById('confirm-modal').classList.remove('active');
                    resolve(true);
                };
            });
        }

        function closeConfirm(val) {
            document.getElementById('confirm-modal').classList.remove('active');
            if (confirmPromiseResolve) confirmPromiseResolve(val);
        }

        function notify(msg) {
            const stack = document.getElementById('toast-stack');
            const t = document.createElement('div');
            t.className = `toast-item glass px-6 py-4 border-l-4 border-indigo-500 text-[10px] font-black uppercase shadow-2xl flex items-center`;
            t.innerText = msg;
            stack.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3000);
        }

        async function fetchInitialData() {
            try {
                const res = await fetch(SCRIPT_URL);
                cloudData = await res.json();
                isDataLoaded = true;
                document.getElementById('login-status').innerText = "ONLINE âœ…";
                document.getElementById('login-status').classList.remove('opacity-0');
            } catch (e) { notify("Gagal Hubungkan Server"); }
        }
        window.onload = fetchInitialData;

        function handleLogin() {
            if (!isDataLoaded) return notify("PROSES DATA...");
            const pass = document.getElementById('pass-input').value.trim().toUpperCase();
            const kelasList = ['7A','7B','7C','7D','7E','7F','8A','8B','8C','8D','8E','8F','9A','9B','9C','9D','9E','9F'];
            
            let role = '', name = '', kelas = '';
            if (cloudData.siswa[pass]) {
                role = 'Siswa'; name = cloudData.siswa[pass].nama; kelas = cloudData.siswa[pass].kelas;
            } else if (kelasList.includes(pass)) {
                role = 'Wali Kelas'; kelas = pass; name = "Wali Kelas " + kelas;
            } else if (pass === 'ADMIN110') {
                role = 'Guru Piket'; name = 'Guru Piket';
            } else { return notify("Kode Salah"); }
            
            window.userRole = role; window.userKelas = kelas;
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            if (role === 'Wali Kelas' || role === 'Guru Piket') {
                document.getElementById('user-display').innerText = "SMPN 110 JAKARTA";
            } else {
                document.getElementById('user-display').innerText = name;
            }

            document.getElementById('user-role-label').innerText = role + (kelas ? ` | ${kelas}` : '');
            
            if (role !== 'Siswa') {
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('btn-rekap').classList.remove('hidden');
                renderAdminTable();
            } else { document.getElementById('view-siswa').classList.remove('hidden'); }
        }

        // CETAK PDF REKAPITULASI (OPTIMASI A4)
        async function downloadRekapPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(14);
            doc.text("SMPN 110 JAKARTA", 105, 15, { align: "center" });
            doc.setFontSize(11);
            doc.text(`REKAPITULASI ABSENSI - KELAS ${window.userKelas || 'SEMUA'}`, 105, 22, { align: "center" });
            
            const rows = [];
            const listSiswa = Object.values(cloudData.siswa)
                .filter(s => window.userRole === 'Guru Piket' ? true : s.kelas === window.userKelas)
                .sort((a,b) => a.nama.localeCompare(b.nama));

            listSiswa.forEach((s, idx) => {
                const s_count = cloudData.izin.filter(i => i.nama === s.nama && i.alasan === 'Sakit').length;
                const i_count = cloudData.izin.filter(i => i.nama === s.nama && i.alasan === 'Izin Penting').length;
                const a_count = cloudData.alpha.filter(a => a[0] === s.nama).length;
                rows.push([idx + 1, s.nama.toUpperCase(), s_count, i_count, a_count, (s_count + i_count + a_count)]);
            });

            doc.autoTable({
                startY: 28,
                head: [['NO', 'NAMA SISWA', 'S', 'I', 'A', 'TOTAL']],
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [16, 185, 129], halign: 'center', fontSize: 9 },
                styles: { halign: 'center', fontSize: 8, cellPadding: 1.5 },
                columnStyles: { 1: { halign: 'left' } },
                margin: { top: 30, bottom: 20 },
                rowPageBreak: 'avoid'
            });

            doc.save(`Rekap_Absensi_110.pdf`);
            notify("Rekap PDF Diunduh");
        }

        async function handleAlphaClick(studentName) {
            const today = new Date().toDateString();
            if (cloudData.alpha.some(a => a[0] === studentName && a[1] === today)) return notify("Sudah hari ini");
            try {
                cloudData.alpha.push([studentName, today]); openRekap(); notify("Alpa +1");
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "save_alpha", nama: studentName }) });
            } catch (e) { notify("Gagal simpan"); }
        }

        function startPress(studentName) {
            pressTimer = setTimeout(async () => {
                if (await showConfirm("Reset", `Hapus data Alpa ${studentName}?`)) {
                    try {
                        cloudData.alpha = cloudData.alpha.filter(a => a[0] !== studentName); openRekap();
                        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "reset_alpha", nama: studentName }) });
                        notify("Data Berhasil Direset");
                    } catch (e) { notify("Gagal Reset"); }
                }
            }, 1000);
        }

        function endPress() { clearTimeout(pressTimer); }

        function renderAdminTable() {
            const db = cloudData.izin || [];
            let filtered = (window.userRole === 'Wali Kelas') ? db.filter(i => i.kelas === window.userKelas) : db;
            document.getElementById('table-admin-body').innerHTML = filtered.map((i, idx) => `
                <tr class="hover:bg-white/5 transition-all">
                    <td class="font-bold opacity-30">${idx+1}</td>
                    <td class="p-4 uppercase font-bold">${i.tanggal}<br><span class="text-[9px] opacity-40">${i.jam}</span></td>
                    <td class="font-black uppercase">${i.nama}</td>
                    <td class="font-bold text-indigo-400 uppercase">${i.alasan}</td>
                    <td>
                        <button onclick="deleteData('${i.id}')" class="text-red-500 font-bold px-4 py-2 hover:bg-red-500/10 rounded-lg">HAPUS</button>
                    </td>
                </tr>`).join('');
        }

        function openRekap() {
            const body = document.getElementById('rekap-body');
            document.getElementById('rekap-modal').classList.add('active');
            const list = Object.values(cloudData.siswa).filter(s => window.userRole === 'Guru Piket' ? true : s.kelas === window.userKelas).sort((a,b) => a.nama.localeCompare(b.nama));
            body.innerHTML = list.map((s, idx) => {
                const s_count = cloudData.izin.filter(i => i.nama === s.nama && i.alasan === 'Sakit').length;
                const i_count = cloudData.izin.filter(i => i.nama === s.nama && i.alasan === 'Izin Penting').length;
                const a_count = cloudData.alpha.filter(a => a[0] === s.nama).length;
                return `
                <tr class="hover:bg-white/5 transition-all">
                    <td class="opacity-30 font-bold">${idx+1}</td>
                    <td class="font-bold uppercase">${s.nama}</td>
                    <td class="font-bold text-orange-400">${s_count}</td>
                    <td class="font-bold text-indigo-400">${i_count}</td>
                    <td class="p-0">
                        <button onmousedown="startPress('${s.nama}')" onmouseup="endPress()" onmouseleave="endPress()" ontouchstart="startPress('${s.nama}')" ontouchend="endPress()" onclick="handleAlphaClick('${s.nama}')" class="w-full h-full py-4 text-red-400 font-black hover:bg-red-500/10 active:scale-90 select-none">${a_count}</button>
                    </td>
                    <td class="font-black text-emerald-400 bg-emerald-500/5">${s_count + i_count + a_count}</td>
                </tr>`;
            }).join('');
        }

        async function syncData() {
            notify("MENYEGARKAN..."); await fetchInitialData();
            if(window.userRole !== 'Siswa') renderAdminTable();
            notify("DATA TERUPDATE");
        }

        async function deleteData(id) {
            if (!(await showConfirm("Hapus", "Hapus data izin ini?"))) return;
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: "delete", id: id}) });
            syncData();
        }

        function triggerLogout() { location.reload(); }
        function closeRekap() { document.getElementById('rekap-modal').classList.remove('active'); }
    </script>
</body>
</html>