<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>E-IZIN SEKOLAH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
*{box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif}
body{
  margin:0;min-height:100vh;display:flex;
  align-items:center;justify-content:center;
  background:linear-gradient(180deg,#0ea5e9,#0b4f6c)
}
.card{
  width:420px;background:linear-gradient(180deg,#0f2f4a,#0b2438);
  border-radius:18px;padding:26px;
  box-shadow:0 25px 60px rgba(0,0,0,.45);
  color:#e5f7ff
}
.hidden{display:none}

.header{
  display:flex;align-items:center;
  justify-content:space-between;
  margin-bottom:12px
}
.header-right{display:flex;gap:12px}
.icon-action{
  cursor:pointer;color:#22d3ee;
  width:22px;height:22px;
}
.icon-action:hover{color:#34d399}

.input{
  width:100%;padding:14px;
  border-radius:14px;border:none;
  outline:none;background:#020617;
  color:#e5e7eb;margin-bottom:12px;
  text-align:center
}
.icon-btn{
  width:100%;padding:14px;
  border-radius:14px;border:none;
  cursor:pointer;font-weight:600;
  display:flex;align-items:center;
  justify-content:center;gap:8px;
  background:linear-gradient(90deg,#22d3ee,#34d399);
  color:#022c22
}

.table-wrapper{
  max-height:260px;
  overflow:auto;
  border-radius:12px;
  border:2px solid #38f2ff;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#020617;
  font-size:13px;
  table-layout:auto;
}
th,td{
  border:1px solid #38f2ff;
  padding:8px;
  text-align:center;
  white-space:nowrap
}
th{
  position:sticky;top:0;
  background:#0b3a5a;color:#38f2ff
}
th.tanggal,td.tanggal,
th.nama,td.nama{
  text-align:left;
  padding:8px 12px
}
tbody tr:nth-child(even){background:#020d1f}
tbody tr:hover{background:#0b4f6c}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <h3 style="text-align:center">E-IZIN SEKOLAH</h3>
  <input id="user" class="input" placeholder="USERNAME / NIS">
  <input id="pass" type="password" class="input" placeholder="PASSWORD">
  <button class="icon-btn" onclick="login()">
    <i data-feather="log-in"></i> MASUK
  </button>
</div>

<!-- WALI -->
<div id="waliBox" class="card hidden">
  <div class="header">
    <h3 id="judulWali"></h3>
    <i data-feather="log-out" class="icon-action" onclick="logout()"></i>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th class="tanggal">Tanggal</th>
          <th class="nama">Nama</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelWali"></tbody>
    </table>
  </div>
</div>

<!-- PIKET -->
<div id="piketBox" class="card hidden">
  <div class="header">
    <h3 id="judulPiket">Data Izin & Sakit Hari Ini</h3>
    <div class="header-right">
      <i data-feather="calendar"
         class="icon-action"
         onclick="togglePiket()"
         title="Hari ini / seluruh hari"></i>
      <i data-feather="log-out"
         class="icon-action"
         onclick="logout()"></i>
    </div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th class="tanggal">Tanggal</th>
          <th>NIS</th>
          <th class="nama">Nama</th>
          <th>Kelas</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelPiket"></tbody>
    </table>
  </div>
</div>

<script>
feather.replace();
const url="https://script.google.com/macros/s/AKfycbyh4rIApWwjXlD0aYFSVrJwua8SZ09X35hu308Qs6FWwg6zevQP8t9xLMgHrQX2nmiv/exec";

let showAllPiket=false;

/* ===== LOGIN ROLE ===== */
function login(){
  if(!user.value||!pass.value){
    Swal.fire("Lengkapi login"); return;
  }

  fetch(url,{
    method:"POST",
    body:JSON.stringify({
      action:"login",
      user:user.value,
      pass:pass.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status!=="ok"){
      Swal.fire("Login gagal"); return;
    }

    loginBox.classList.add("hidden");

    if(res.role==="WALI"){
      waliBox.classList.remove("hidden");
      judulWali.innerText="Laporan Kelas "+res.kelas;
      loadWali(res.kelas);
    }
    else if(res.role==="PIKET"){
      piketBox.classList.remove("hidden");
      loadPiket();
    }
  });
}

/* ===== PIKET ===== */
function togglePiket(){
  showAllPiket=!showAllPiket;
  loadPiket();
}

function loadPiket(){
  fetch(url+"?mode=izin")
  .then(r=>r.json())
  .then(data=>{
    const today=new Date().toISOString().slice(0,10);
    tabelPiket.innerHTML="";
    let no=1;

    const filtered = showAllPiket
      ? data
      : data.filter(d=>d.tanggal===today);

    judulPiket.innerText = showAllPiket
      ? "Data Izin & Sakit Seluruh Hari"
      : "Data Izin & Sakit Hari Ini";

    filtered.forEach(d=>{
      tabelPiket.innerHTML+=`
      <tr>
        <td>${no++}</td>
        <td class="tanggal">${d.tanggal}</td>
        <td>${d.nis}</td>
        <td class="nama">${d.nama}</td>
        <td>${d.kelas}</td>
        <td>${d.jenis}</td>
      </tr>`;
    });

    if(no===1){
      tabelPiket.innerHTML=
        `<tr><td colspan="6">Tidak ada data</td></tr>`;
    }
  });
}

/* ===== WALI ===== */
function loadWali(kelas){
  fetch(url+"?mode=izin")
  .then(r=>r.json())
  .then(data=>{
    tabelWali.innerHTML="";
    let no=1;
    data.filter(d=>d.kelas===kelas)
    .forEach(d=>{
      tabelWali.innerHTML+=`
      <tr>
        <td>${no++}</td>
        <td class="tanggal">${d.tanggal}</td>
        <td class="nama">${d.nama}</td>
        <td>${d.jenis}</td>
      </tr>`;
    });
  });
}

/* ===== LOGOUT ===== */
function logout(){
  location.reload();
}
</script>

</body>
</html>
